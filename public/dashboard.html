<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#16213e">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <!-- Para iOS splash screens (opcional) -->
    <link rel="apple-touch-startup-image" href="/icons/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <!-- Agregar estos meta tags espec√≠ficos de Apple -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Polla 2025">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <title>Mi Dashboard - Polla Mundialista 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>üèÜ Polla Mundialista</h1>
                </div>
                <div class="header-right">
                    <div class="notifications-container">
                        <button id="enableNotifications" class="btn btn-primary btn-small" onclick="enablePushNotifications()">
                            üîï Activar Notificaciones
                        </button>
                        <button class="notifications-btn" onclick="toggleNotifications()">
                            üîî
                            <span class="notifications-badge" id="notificationsBadge" style="display: none;">0</span>
                        </button>
                        <!-- Agregar en el header-right, despu√©s del bot√≥n de notificaciones -->
                        <button id="installButton" class="btn btn-primary btn-small" style="display: none;" onclick="installPWA()">
                            üì± Instalar App
                        </button>
                    </div>
                    <!-- BOTONES TEMPORALES PARA DEBUG iOS -->
                    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                        <h4>üß™ Debug iOS</h4>
                        
                        <button onclick="checkIOSStatus()" class="btn btn-warning btn-small">
                            üìä Ver Estado
                        </button>
                        
                        <button onclick="testNotificationiOS()" class="btn btn-info btn-small">
                            üîî Test Notificaci√≥n
                        </button>
                        
                        <button onclick="resetPermissionsiOS()" class="btn btn-danger btn-small">
                            üîÑ Reset Permisos
                        </button>
                    </div>
                    <div class="user-info">
                        <span id="userName">Cargando...</span>
                        <button class="btn btn-secondary btn-small" onclick="logout()">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div id="accountStatus" class="status-banner"></div>

            <!-- Informaci√≥n del Torneo Activo -->
            <div class="dashboard-card full-width tournament-info">
                <div id="activeTournamentInfo">
                    <p>Cargando informaci√≥n del torneo...</p>
                </div>
                <!-- ‚ú® NUEVO BOT√ìN DE REGLAS -->
                <div class="tournament-actions">
                    <button class="btn btn-secondary btn-small" onclick="showTournamentRules()" id="rulesButton" style="display: none;">
                        üìã Ver Reglas del Torneo
                    </button>
                </div>
            </div>


            <div class="dashboard-grid">
                <!-- Mis Puntos -->
                <div class="dashboard-card">
                    <h3>üéØ Mis Puntos</h3>
                    <div class="points-display">
                        <span class="points-number" id="userPoints">0</span>
                        <span class="points-label">puntos totales</span>
                    </div>
                </div>

                <!-- Posici√≥n en la Tabla -->
                <div class="dashboard-card">
                    <h3>üèÖ Mi Posici√≥n</h3>
                    <div class="position-display">
                        <span class="position-number" id="userPosition">#-</span>
                        <span class="position-label">de <span id="totalParticipants">0</span></span>
                    </div>
                </div>

                <!-- Tabla de Posiciones -->
                <div class="dashboard-card full-width">
                    <div class="leaderboard-header">
                        <h3>üèÜ Tabla de Posiciones</h3>
                        <button class="btn btn-secondary btn-small" onclick="loadLeaderboard()">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div id="leaderboardContainer">
                        <p>Cargando tabla de posiciones...</p>
                    </div>
                    <div class="leaderboard-footer">
                        <button class="btn btn-primary" onclick="showFullLeaderboard()">
                            Ver Tabla Completa
                        </button>
                    </div>
                </div>


                <!-- Pr√≥ximos Partidos -->
                <div class="dashboard-card full-width">
                    <!--  <h3>‚öΩ Pr√≥ximos Partidos</h3> -->
                    <div id="upcomingMatches">
                        <p>Cargando partidos...</p>
                    </div>
                </div>

                <!-- Mis Predicciones -->
                <div class="dashboard-card full-width">
                    <!-- <h3>üìù Mis Predicciones</h3> -->
                    <div id="myPredictions">
                        <p>A√∫n no has hecho predicciones</p>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Polla Mundialista</p>
        </footer>
    </div>

    <script src="dashboard.js"></script>
    <script>
// Funciones de debug para iOS
window.checkIOSStatus = async function() {
    let msg = '=== ESTADO iOS ===\n';
    msg += `Permisos: ${Notification.permission}\n`;
    msg += `Service Worker: ${'serviceWorker' in navigator ? 'S√≠' : 'No'}\n`;
    msg += `Push Manager: ${'PushManager' in window ? 'S√≠' : 'No'}\n`;
    msg += `PWA Mode: ${window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches}\n`;
    
    try {
        const reg = await navigator.serviceWorker.ready;
        const sub = await reg.pushManager.getSubscription();
        msg += `Suscripci√≥n: ${sub ? 'ACTIVA' : 'No hay'}`;
    } catch (e) {
        msg += `Error: ${e.message}`;
    }
    
    alert(msg);
}

window.testNotificationiOS = async function() {
    try {
        if (Notification.permission === 'granted') {
            new Notification('‚úÖ Test iOS', {
                body: 'Las notificaciones funcionan!',
                icon: '/icons/icon-192x192.png'
            });
            alert('‚úÖ Notificaci√≥n enviada!');
        } else {
            const perm = await Notification.requestPermission();
            alert(`Permiso: ${perm}`);
        }
    } catch (e) {
        alert(`Error: ${e.message}`);
    }
}

window.resetPermissionsiOS = function() {
    alert('Para resetear permisos:\n\n1. Configuraci√≥n iOS\n2. Safari\n3. Avanzado\n4. Datos de sitios web\n5. Busca y elimina polla-mundialista');
}
</script>
</body>
</html>
